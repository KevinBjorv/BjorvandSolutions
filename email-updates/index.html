<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Smart Indie | Email Updates</title>
  <meta name="description" content="Join the Smart Indie email list to get updates, resources, and launch news for beginner indie devs.">
  <link rel="apple-touch-icon" sizes="180x180" href="/assets/favicon/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/assets/favicon/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/assets/favicon/favicon-16x16.png">
  <link rel="icon" href="/assets/favicon/favicon.ico">
  <link rel="manifest" href="/assets/favicon/site.webmanifest">
  <link rel="stylesheet" href="/assets/css/styles.css">
  <script src="https://challenges.cloudflare.com/turnstile/v0/api.js?onload=onTurnstileLoad" defer></script>
</head>
<body class="email-page">
  <main class="email-fullscreen">
    <section class="subscribe-card" aria-labelledby="subscribe-title">
      <div>
        <p class="pill">Free template • Delivered instantly</p>
        <h1 id="subscribe-title">Get the Smart Indie productivity template</h1>
        <p>Enter your email to receive the Trello template and join the Smart Indie list for practical tips on finishing your first game.</p>
      </div>
      <form id="subscribeForm" class="subscribe-form" novalidate>
        <label for="email">Email</label>
        <input type="email" id="email" name="email" placeholder="you@example.com" required autocomplete="email">
        <div id="turnstile-container" class="cf-turnstile" data-sitekey="0x4AAAAAACKzhfSM5J4krA5T" data-size="invisible"></div>
        <button type="submit" id="submitButton" class="button primary">Get the template</button>
        <p id="formFeedback" class="form-feedback" role="status" aria-live="polite"></p>
      </form>
    </section>
  </main>

  <footer>
      <div class="footer-content">
        <div>© Bjorvand Solutions 2025 • Company registration number: 836 135 652 (Norway)</div>
      <div class="footer-links">
        <a href="/">Smart Indie</a>
        <a href="/games/">Games</a>
        <a href="/faq/">FAQ</a>
        <a href="/email-updates/">Email Updates</a>
        <a href="/about-contact/">About & Contact</a>
      </div>
      <div>kevin@smartindie.dev</div>
    </div>
  </footer>

  <script src="/assets/js/global.js"></script>
  <script>
    let turnstileWidgetId = null;
    const form = document.getElementById('subscribeForm');
    const emailInput = document.getElementById('email');
    const feedbackEl = document.getElementById('formFeedback');
    const submitButton = document.getElementById('submitButton');

    function setFeedback(message, isError = false) {
      feedbackEl.textContent = message;
      feedbackEl.classList.toggle('error', isError);
      feedbackEl.classList.toggle('success', !isError);
    }

    function setSubmitting(isSubmitting) {
      submitButton.disabled = isSubmitting;
      submitButton.textContent = isSubmitting ? 'Submitting…' : 'Get the template';
    }

    async function submitWithToken(token) {
      const email = emailInput.value.trim();
      if (!email) {
        setFeedback('Please enter your email address.', true);
        setSubmitting(false);
        return;
      }

      try {
        const response = await fetch('/api/subscribe', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, token })
        });

        if (response.ok) {
          setFeedback('Success! Check your inbox for the template.', false);
          form.reset();
        } else if (response.status === 400) {
          setFeedback('Bot check failed. Please try again.', true);
        } else if (response.status === 429) {
          setFeedback('Too many attempts. Please wait and try again.', true);
        } else {
          setFeedback('Something went wrong. Please try again later.', true);
        }
      } catch (error) {
        setFeedback('Network error. Please try again.', true);
      } finally {
        setSubmitting(false);
        if (turnstileWidgetId && typeof turnstile.reset === 'function') {
          turnstile.reset(turnstileWidgetId);
        }
      }
    }

    form.addEventListener('submit', (event) => {
      event.preventDefault();
      setSubmitting(true);
      setFeedback('');

      if (!turnstileWidgetId) {
        setFeedback('Security check not ready. Please try again.', true);
        setSubmitting(false);
        return;
      }

      if (typeof turnstile !== 'undefined' && typeof turnstile.execute === 'function') {
        turnstile.execute(turnstileWidgetId, {
          action: 'subscribe'
        });
      }
    });

    function onTurnstileLoad() {
      turnstileWidgetId = turnstile.render('#turnstile-container', {
        sitekey: '0x4AAAAAACKzhfSM5J4krA5T',
        size: 'invisible',
        callback: (token) => submitWithToken(token),
        'error-callback': () => {
          setFeedback('Security check failed. Please refresh and try again.', true);
          setSubmitting(false);
        }
      });
    }
  </script>
</body>
</html>
